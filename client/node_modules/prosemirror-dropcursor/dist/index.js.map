{"version":3,"file":"index.js","sources":["../src/dropcursor.js"],"sourcesContent":["import {Plugin} from \"prosemirror-state\"\nimport {dropPoint} from \"prosemirror-transform\"\n\n// :: (options: ?Object) â†’ Plugin\n// Create a plugin that, when added to a ProseMirror instance,\n// causes a decoration to show up at the drop position when something\n// is dragged over the editor.\n//\n//   options::- These options are supported:\n//\n//     color:: ?string\n//     The color of the cursor. Defaults to `black`.\n//\n//     width:: ?number\n//     The precise width of the cursor in pixels. Defaults to 1.\n//\n//     class:: ?string\n//     A CSS class name to add to the cursor element.\nexport function dropCursor(options = {}) {\n  return new Plugin({\n    view(editorView) { return new DropCursorView(editorView, options) }\n  })\n}\n\nclass DropCursorView {\n  constructor(editorView, options) {\n    this.editorView = editorView\n    this.width = options.width || 1\n    this.color = options.color || \"black\"\n    this.class = options.class\n    this.cursorPos = null\n    this.element = null\n    this.timeout = null\n\n    this.handlers = [\"dragover\", \"dragend\", \"drop\", \"dragleave\"].map(name => {\n      let handler = e => this[name](e)\n      editorView.dom.addEventListener(name, handler)\n      return {name, handler}\n    })\n  }\n\n  destroy() {\n    this.handlers.forEach(({name, handler}) => this.editorView.dom.removeEventListener(name, handler))\n  }\n\n  update(editorView, prevState) {\n    if (this.cursorPos != null && prevState.doc != editorView.state.doc) this.updateOverlay()\n  }\n\n  setCursor(pos) {\n    if (pos == this.cursorPos) return\n    this.cursorPos = pos\n    if (pos == null) {\n      this.element.parentNode.removeChild(this.element)\n      this.element = null\n    } else {\n      this.updateOverlay()\n    }\n  }\n\n  updateOverlay() {\n    let $pos = this.editorView.state.doc.resolve(this.cursorPos), rect\n    if (!$pos.parent.inlineContent) {\n      let before = $pos.nodeBefore, after = $pos.nodeAfter\n      if (before || after) {\n        let nodeRect = this.editorView.nodeDOM(this.cursorPos - (before ?  before.nodeSize : 0)).getBoundingClientRect()\n        let top = before ? nodeRect.bottom : nodeRect.top\n        if (before && after)\n          top = (top + this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top) / 2\n        rect = {left: nodeRect.left, right: nodeRect.right, top: top - this.width / 2, bottom: top + this.width / 2}\n      }\n    }\n    if (!rect) {\n      let coords = this.editorView.coordsAtPos(this.cursorPos)\n      rect = {left: coords.left - this.width / 2, right: coords.left + this.width / 2, top: coords.top, bottom: coords.bottom}\n    }\n\n    let parent = this.editorView.dom.offsetParent\n    if (!this.element) {\n      this.element = parent.appendChild(document.createElement(\"div\"))\n      if (this.class) this.element.className = this.class\n      this.element.style.cssText = \"position: absolute; z-index: 50; pointer-events: none; background-color: \" + this.color\n    }\n    let parentRect = !parent || parent == document.body && getComputedStyle(parent).position == \"static\"\n        ? {left: -pageXOffset, top: -pageYOffset} : parent.getBoundingClientRect()\n    this.element.style.left = (rect.left - parentRect.left) + \"px\"\n    this.element.style.top = (rect.top - parentRect.top) + \"px\"\n    this.element.style.width = (rect.right - rect.left) + \"px\"\n    this.element.style.height = (rect.bottom - rect.top) + \"px\"\n  }\n\n  scheduleRemoval(timeout) {\n    clearTimeout(this.timeout)\n    this.timeout = setTimeout(() => this.setCursor(null), timeout)\n  }\n\n  dragover(event) {\n    if (!this.editorView.editable) return\n    let pos = this.editorView.posAtCoords({left: event.clientX, top: event.clientY})\n    if (pos) {\n      let target = pos.pos\n      if (this.editorView.dragging && this.editorView.dragging.slice) {\n        target = dropPoint(this.editorView.state.doc, target, this.editorView.dragging.slice)\n        if (target == null) target = pos.pos\n      }\n      this.setCursor(target)\n      this.scheduleRemoval(5000)\n    }\n  }\n\n  dragend() {\n    this.scheduleRemoval(20)\n  }\n\n  drop() {\n    this.scheduleRemoval(20)\n  }\n\n  dragleave(event) {\n    if (event.target == this.editorView.dom || !this.editorView.dom.contains(event.relatedTarget))\n      this.setCursor(null)\n  }\n}\n"],"names":["Plugin","let","this","dropPoint"],"mappings":"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"}