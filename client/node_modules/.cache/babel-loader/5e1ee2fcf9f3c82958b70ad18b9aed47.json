{"ast":null,"code":"import { Plugin, PluginKey } from 'prosemirror-state'; // eslint-disable-line\n\nimport { ySyncPluginKey, getRelativeSelection } from './sync-plugin.js';\nimport { UndoManager, Item, ContentType, XmlElement, Text } from 'yjs';\nexport const undo = state => {\n  const undoManager = yUndoPluginKey.getState(state).undoManager;\n\n  if (undoManager != null) {\n    undoManager.undo();\n    return true;\n  }\n};\nexport const redo = state => {\n  const undoManager = yUndoPluginKey.getState(state).undoManager;\n\n  if (undoManager != null) {\n    undoManager.redo();\n    return true;\n  }\n};\nexport const yUndoPluginKey = new PluginKey('y-undo');\nexport const yUndoPlugin = ({\n  protectedNodes = new Set(['paragraph']),\n  trackedOrigins = []\n} = {}) => new Plugin({\n  key: yUndoPluginKey,\n  state: {\n    init: (initargs, state) => {\n      // TODO: check if plugin order matches and fix\n      const ystate = ySyncPluginKey.getState(state);\n      const undoManager = new UndoManager(ystate.type, {\n        trackedOrigins: new Set([ySyncPluginKey].concat(trackedOrigins)),\n        deleteFilter: item => !(item instanceof Item) || !(item.content instanceof ContentType) || !(item.content.type instanceof Text || item.content.type instanceof XmlElement && protectedNodes.has(item.content.type.nodeName)) || item.content.type._length === 0\n      });\n      return {\n        undoManager,\n        prevSel: null,\n        hasUndoOps: undoManager.undoStack.length > 0,\n        hasRedoOps: undoManager.redoStack.length > 0\n      };\n    },\n    apply: (tr, val, oldState, state) => {\n      const binding = ySyncPluginKey.getState(state).binding;\n      const undoManager = val.undoManager;\n      const hasUndoOps = undoManager.undoStack.length > 0;\n      const hasRedoOps = undoManager.redoStack.length > 0;\n\n      if (binding) {\n        return {\n          undoManager,\n          prevSel: getRelativeSelection(binding, oldState),\n          hasUndoOps,\n          hasRedoOps\n        };\n      } else {\n        if (hasUndoOps !== val.hasUndoOps || hasRedoOps !== val.hasRedoOps) {\n          return Object.assign({}, val, {\n            hasUndoOps: undoManager.undoStack.length > 0,\n            hasRedoOps: undoManager.redoStack.length > 0\n          });\n        } else {\n          // nothing changed\n          return val;\n        }\n      }\n    }\n  },\n  view: view => {\n    const ystate = ySyncPluginKey.getState(view.state);\n    const undoManager = yUndoPluginKey.getState(view.state).undoManager;\n    undoManager.on('stack-item-added', ({\n      stackItem\n    }) => {\n      const binding = ystate.binding;\n\n      if (binding) {\n        stackItem.meta.set(binding, yUndoPluginKey.getState(view.state).prevSel);\n      }\n    });\n    undoManager.on('stack-item-popped', ({\n      stackItem\n    }) => {\n      const binding = ystate.binding;\n\n      if (binding) {\n        binding.beforeTransactionSelection = stackItem.meta.get(binding) || binding.beforeTransactionSelection;\n      }\n    });\n    return {\n      destroy: () => {\n        undoManager.destroy();\n      }\n    };\n  }\n});","map":{"version":3,"sources":["/Users/meeopp/Development/Others/editor-yjs/client/node_modules/y-prosemirror/src/plugins/undo-plugin.js"],"names":["Plugin","PluginKey","ySyncPluginKey","getRelativeSelection","UndoManager","Item","ContentType","XmlElement","Text","undo","state","undoManager","yUndoPluginKey","getState","redo","yUndoPlugin","protectedNodes","Set","trackedOrigins","key","init","initargs","ystate","type","concat","deleteFilter","item","content","has","nodeName","_length","prevSel","hasUndoOps","undoStack","length","hasRedoOps","redoStack","apply","tr","val","oldState","binding","Object","assign","view","on","stackItem","meta","set","beforeTransactionSelection","get","destroy"],"mappings":"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","sourcesContent":["\nimport { Plugin, PluginKey } from 'prosemirror-state' // eslint-disable-line\n\nimport { ySyncPluginKey, getRelativeSelection } from './sync-plugin.js'\nimport { UndoManager, Item, ContentType, XmlElement, Text } from 'yjs'\n\nexport const undo = state => {\n  const undoManager = yUndoPluginKey.getState(state).undoManager\n  if (undoManager != null) {\n    undoManager.undo()\n    return true\n  }\n}\n\nexport const redo = state => {\n  const undoManager = yUndoPluginKey.getState(state).undoManager\n  if (undoManager != null) {\n    undoManager.redo()\n    return true\n  }\n}\n\nexport const yUndoPluginKey = new PluginKey('y-undo')\n\nexport const yUndoPlugin = ({ protectedNodes = new Set(['paragraph']), trackedOrigins = [] } = {}) => new Plugin({\n  key: yUndoPluginKey,\n  state: {\n    init: (initargs, state) => {\n      // TODO: check if plugin order matches and fix\n      const ystate = ySyncPluginKey.getState(state)\n      const undoManager = new UndoManager(ystate.type, {\n        trackedOrigins: new Set([ySyncPluginKey].concat(trackedOrigins)),\n        deleteFilter: item => !(item instanceof Item) ||\n                              !(item.content instanceof ContentType) ||\n                              !(item.content.type instanceof Text ||\n                              (item.content.type instanceof XmlElement && protectedNodes.has(item.content.type.nodeName))) ||\n                              item.content.type._length === 0\n      })\n      return {\n        undoManager,\n        prevSel: null,\n        hasUndoOps: undoManager.undoStack.length > 0,\n        hasRedoOps: undoManager.redoStack.length > 0\n      }\n    },\n    apply: (tr, val, oldState, state) => {\n      const binding = ySyncPluginKey.getState(state).binding\n      const undoManager = val.undoManager\n      const hasUndoOps = undoManager.undoStack.length > 0\n      const hasRedoOps = undoManager.redoStack.length > 0\n      if (binding) {\n        return {\n          undoManager,\n          prevSel: getRelativeSelection(binding, oldState),\n          hasUndoOps,\n          hasRedoOps\n        }\n      } else {\n        if (hasUndoOps !== val.hasUndoOps || hasRedoOps !== val.hasRedoOps) {\n          return Object.assign({}, val, {\n            hasUndoOps: undoManager.undoStack.length > 0,\n            hasRedoOps: undoManager.redoStack.length > 0\n          })\n        } else { // nothing changed\n          return val\n        }\n      }\n    }\n  },\n  view: view => {\n    const ystate = ySyncPluginKey.getState(view.state)\n    const undoManager = yUndoPluginKey.getState(view.state).undoManager\n    undoManager.on('stack-item-added', ({ stackItem }) => {\n      const binding = ystate.binding\n      if (binding) {\n        stackItem.meta.set(binding, yUndoPluginKey.getState(view.state).prevSel)\n      }\n    })\n    undoManager.on('stack-item-popped', ({ stackItem }) => {\n      const binding = ystate.binding\n      if (binding) {\n        binding.beforeTransactionSelection = stackItem.meta.get(binding) || binding.beforeTransactionSelection\n      }\n    })\n    return {\n      destroy: () => {\n        undoManager.destroy()\n      }\n    }\n  }\n})\n"]},"metadata":{},"sourceType":"module"}